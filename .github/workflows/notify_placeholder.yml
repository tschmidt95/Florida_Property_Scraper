name: Notify on monitor-failure (template)

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: read
  secrets: read

jobs:
  notify:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'monitor-failure')
    steps:
      - name: Determine provider and webhook
        run: |
          # Use ALERT_PROVIDER secret to select payload format (slack|teams|generic). Default to slack.
          PROVIDER="${{ secrets.ALERT_PROVIDER }}"
          if [ -z "$PROVIDER" ]; then
            PROVIDER=slack
          fi

          if [ -z "${{ secrets.ALERT_WEBHOOK_URL }}" ]; then
            echo "No ALERT_WEBHOOK_URL is configured. This is a template placeholder; add the secret to enable notifications."
            exit 0
          fi

          echo "PROVIDER=$PROVIDER" >> $GITHUB_ENV
          echo "WEBHOOK_URL=${{ secrets.ALERT_WEBHOOK_URL }}" >> $GITHUB_ENV

      - name: Build and send notification payload
        run: |
          set -euo pipefail
          PROVIDER="${PROVIDER}"
          WEBHOOK_URL="${WEBHOOK_URL}"

          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY_RAW="${{ github.event.issue.body }}"
          ISSUE_BODY=$(jq -Rs . <<< "$ISSUE_BODY_RAW")

          echo "Sending notification using provider: $PROVIDER"

          if [ "$PROVIDER" = "slack" ]; then
            # Slack Blocks payload (rich message with button)
            payload=$(jq -n --arg title "$ISSUE_TITLE" --arg url "$ISSUE_URL" --arg body_raw "$ISSUE_BODY_RAW" \
              '{blocks: [ {type: "section", text: {type: "mrkdwn", text: (":rotating_light: *" + $title + "*\n" + ($body_raw | fromjson? // $body_raw))}}, {type: "section", fields: [{type: "mrkdwn", text: "*Repo:* '" + "'${GITHUB_REPOSITORY}'" + "'"}, {type: "mrkdwn", text: "*Issue:* <" + $url + "|" + $title + ">"}]}, {type: "actions", elements: [{type: "button", text: {type: "plain_text", text: "View issue"}, url: $url}]}] }')
          elif [ "$PROVIDER" = "teams" ]; then
            # Teams message card with action button
            payload=$(jq -n --arg title "$ISSUE_TITLE" --arg url "$ISSUE_URL" --arg body_raw "$ISSUE_BODY_RAW" '{title: $title, text: ($body_raw | fromjson? // $body_raw), potentialAction: [{"@type": "OpenUri", name: "View issue", targets: [{os: "default", uri: $url}]}]}')
          else
            # Generic structured payload
            payload=$(jq -n --arg title "$ISSUE_TITLE" --arg url "$ISSUE_URL" --arg body "$ISSUE_BODY" '{alert_type: "image_monitor_failure", title: $title, url: $url, body: ($body | fromjson? // $body)}')
          fi

          # Send and capture response (status + body) for diagnostics; do NOT print webhook URL.
          RESP_FILE="/tmp/notify_resp_$$.txt"
          STATUS_CODE=$(curl -sS -w "%{http_code}" -o "$RESP_FILE" -X POST -H 'Content-Type: application/json' -d "$payload" "$WEBHOOK_URL" || true)
          echo "Webhook response status: $STATUS_CODE"
          echo "Response body (first 500 chars):"
          head -c 500 "$RESP_FILE" || true

      - name: Done
        run: echo "Notification template executed (no-op if secret not provided)."
name: CI

on:
  push:
    branches: [main, feature/migrate-to-scrapy]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python: ['3.10', '3.11']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Setup OS deps (for Scrapy native deps)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            jq \
            build-essential \
            libxml2-dev \
            libxslt1-dev \
            zlib1g-dev \
            libffi-dev \
            libssl-dev
          sudo rm -rf /var/lib/apt/lists/*

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python }}-

      - name: Upgrade pip
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install runtime/test deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Install project + test extras (includes httpx for FastAPI TestClient).
          python -m pip install -e ".[test]" || python -m pip install -e .
          # Safety: ensure httpx is present even if extras aren't configured.
          python -m pip install "httpx>=0.27"
          
      - name: Install package (editable)
        run: python -m pip install -e .

      - name: Smoke tests
        run: |
          export PYTEST_DISABLE_PLUGIN_AUTOLOAD=1
          export PYTHONWARNINGS=error
          python -m pytest -q tests/test_smoke.py -r w

      - name: Lint (flake8)
        run: |
          python -m flake8 || true

      - name: Run tests
        run: |
          export PYTEST_DISABLE_PLUGIN_AUTOLOAD=1
          export PYTHONWARNINGS=error
          python -m pytest -q -r w

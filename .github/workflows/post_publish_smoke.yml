name: Post-publish smoke check

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to check (optional, overrides release tag)'
        required: false

permissions:
  contents: read
  packages: read

jobs:
  smoke-check:
    runs-on: ubuntu-22.04
    env:
      CHECK_TAG: ${{ github.event.inputs.tag || github.event.release.tag_name }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull published image (with retries)
        run: |
          set -euo pipefail
          TAG="${CHECK_TAG}"
          REPO=ghcr.io/tschmidt95/florida-scraper
          ATTEMPTS=12
          SLEEP=20
          i=1
          until docker pull "${REPO}:${TAG}"; do
            if [ "$i" -ge "$ATTEMPTS" ]; then
              echo "ERROR: failed to pull ${REPO}:${TAG} after ${ATTEMPTS} attempts"
              echo "Tip: the image may not have been published yet; wait a bit and check the publish workflow logs."
              echo "Helpful debug: view publish workflow runs for this tag: https://github.com/${{ github.repository }}/actions/runs?query=tag%3A${TAG}"
              exit 1
            fi
            echo "Pull failed, waiting ${SLEEP}s before retry ($i/$ATTEMPTS)..."
            i=$((i+1))
            sleep "$SLEEP"
          done

      - name: Run import smoke check
        run: |
          docker run --rm ghcr.io/tschmidt95/florida-scraper:${CHECK_TAG} \
            python - <<'PY'
          import importlib.util, sys
          spec = importlib.util.find_spec("florida_property_scraper")
          if spec is None:
              print("ERROR: import failed")
              sys.exit(2)
          print("OK:", spec.origin)
          PY

      - name: Show image digest (for logs)
        run: |
          docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/tschmidt95/florida-scraper:${CHECK_TAG} || true

  delayed-retry:
    needs: smoke-check
    runs-on: ubuntu-22.04
    if: ${{ always() }}
    env:
      CHECK_TAG: ${{ github.event.inputs.tag || github.event.release.tag_name }}
    steps:
      - name: Check whether initial smoke-check failed
        run: |
          echo "Initial job conclusion: '${{ needs.smoke-check.conclusion }}'"
          if [ "${{ needs.smoke-check.conclusion }}" != "failure" ]; then
            echo "Previous smoke-check did not fail; skipping delayed retry."
            exit 0
          fi

      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait and retry pull + import check
        run: |
          set -euo pipefail
          TAG="${CHECK_TAG}"
          REPO=ghcr.io/tschmidt95/florida-scraper
          echo "Initial check failed; waiting 90s before retry..."
          sleep 90
          ATTEMPTS=8
          SLEEP=15
          i=1
          until docker pull "${REPO}:${TAG}"; do
            if [ "$i" -ge "$ATTEMPTS" ]; then
              echo "ERROR: failed to pull ${REPO}:${TAG} after ${ATTEMPTS} attempts"
              exit 1
            fi
            echo "Pull failed, waiting ${SLEEP}s before retry ($i/$ATTEMPTS)..."
            i=$((i+1))
            sleep "$SLEEP"
          done
          docker run --rm "${REPO}:${TAG}" python - <<'PY'
          import importlib.util, sys
          spec = importlib.util.find_spec("florida_property_scraper")
          if spec is None:
              print("ERROR: import failed")
              sys.exit(2)
          print("OK:", spec.origin)
          PY

name: Notify on monitor-failure (v2)

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:

permissions:
  issues: read

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'monitor-failure')) || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Determine provider and webhook
        run: |
          # Use ALERT_PROVIDER secret to select payload format (slack|teams|generic). Default to slack.
          PROVIDER="${{ secrets.ALERT_PROVIDER }}"
          if [ -z "$PROVIDER" ]; then
            PROVIDER=slack
          fi

          if [ -z "${{ secrets.ALERT_WEBHOOK_URL }}" ]; then
            echo "No ALERT_WEBHOOK_URL is configured. This is a template placeholder; add the secret to enable notifications."
            exit 0
          fi

          echo "PROVIDER=$PROVIDER" >> $GITHUB_ENV
          echo "WEBHOOK_URL=${{ secrets.ALERT_WEBHOOK_URL }}" >> $GITHUB_ENV

      - name: Optional: send test payload to ALERT_WEBHOOK_URL_TEST
        if: ${{ secrets.ALERT_WEBHOOK_URL_TEST != '' }}
        run: |
          set -euo pipefail
          TEST_URL='${{ secrets.ALERT_WEBHOOK_URL_TEST }}'
          echo 'Sending test payload to ALERT_WEBHOOK_URL_TEST...'
          payload=$(jq -n --arg repo "${{ github.repository }}" --arg issue "${{ github.event.issue.html_url || github.event.inputs.issue_url }}" '{test: true, repo: $repo, issue: $issue, note: "Test alert from notify template"}')
          RESP_FILE="/tmp/notify_test_resp_$$.txt"
          STATUS_CODE=$(curl -sS -w "%{http_code}" -o "$RESP_FILE" -X POST -H 'Content-Type: application/json' -d "$payload" "$TEST_URL" || true)
          echo "Test webhook response status: $STATUS_CODE"
          echo "Test response body (first 500 chars):"
          head -c 500 "$RESP_FILE" || true

      - name: Build and send notification payload
        run: |
          set -euo pipefail
          ISSUE_URL="${{ github.event.issue.html_url || github.event.inputs.issue_url }}"
          ISSUE_TITLE="${{ github.event.issue.title || github.event.inputs.issue_title }}"
          ISSUE_BODY_RAW="${{ github.event.issue.body || github.event.inputs.issue_body }}"
          ISSUE_BODY=$(jq -Rs . <<< "$ISSUE_BODY_RAW")

          echo "Sending notification using provider: ${{ env.PROVIDER }}"

          if [ "${{ env.PROVIDER }}" = "slack" ]; then
            payload=$(jq -n --arg title "$ISSUE_TITLE" --arg url "$ISSUE_URL" --arg body_raw "$ISSUE_BODY_RAW" --arg repo "${GITHUB_REPOSITORY}" '{blocks: [ {type: "section", text: {type: "mrkdwn", text: (":rotating_light: *" + $title + "*\n" + ($body_raw | fromjson? // $body_raw))}}, {type: "section", fields: [{type: "mrkdwn", text: ("*Repo:* " + $repo)}, {type: "mrkdwn", text: ("*Issue:* <" + $url + "|" + $title + ">")} ]}, {type: "actions", elements: [{type: "button", text: {type: "plain_text", text: "View issue"}, url: $url}]}] }')
          elif [ "${{ env.PROVIDER }}" = "teams" ]; then
            payload=$(jq -n --arg title "$ISSUE_TITLE" --arg url "$ISSUE_URL" --arg body_raw "$ISSUE_BODY_RAW" '{title: $title, text: ($body_raw | fromjson? // $body_raw), potentialAction: [{"@type": "OpenUri", name: "View issue", targets: [{os: "default", uri: $url}]}]}')
          else
            payload=$(jq -n --arg title "$ISSUE_TITLE" --arg url "$ISSUE_URL" --arg body "$ISSUE_BODY" '{alert_type: "image_monitor_failure", title: $title, url: $url, body: ($body | fromjson? // $body)}')
          fi

          RESP_FILE="/tmp/notify_resp_$$.txt"
          STATUS_CODE=$(curl -sS -w "%{http_code}" -o "$RESP_FILE" -X POST -H 'Content-Type: application/json' -d "$payload" "${{ env.WEBHOOK_URL }}" || true)
          echo "Webhook response status: $STATUS_CODE"
          echo "Response body (first 500 chars):"
          head -c 500 "$RESP_FILE" || true

      - name: Upload webhook responses
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notify-responses
          path: |
            /tmp/notify_resp_*.txt
            /tmp/notify_test_resp_*.txt

      - name: Done
        run: echo "Notification template executed (no-op if secret not provided)."